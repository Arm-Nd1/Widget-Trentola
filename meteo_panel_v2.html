<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meteo ‚Äî pannello nero v2 (iCUE)</title>
<style>
  :root{
    --text:#e6edf3; --muted:#9aa7b3;
  }
  html,body{height:100%;margin:0;color:var(--text);font:16px system-ui, -apple-system, Segoe UI, Roboto}
  body{background:#0a0c10}
  .wrap{height:100%;padding:14px;box-sizing:border-box;display:flex;flex-direction:column;gap:12px}
  /* TOP PANEL */
  .top{flex:1;min-height:0;border-radius:18px;background:#0b0e13;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 6px 24px rgba(0,0,0,.35);padding:16px;display:grid;grid-template-columns: 1fr 1fr 1fr;grid-template-rows: auto 1fr auto;gap:12px}
  .cell{display:flex;align-items:center;gap:8px}
  .time{font-weight:800}
  .wind{font-weight:700}
  .bigtemp{justify-content:flex-end;align-items:flex-start;font-size:110px;font-weight:900;line-height:.9;text-shadow:0 2px 6px rgba(0,0,0,.5)}
  .icon{justify-content:center;align-items:center;font-size:64px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
  .city{justify-content:flex-end;align-items:flex-end;font-weight:800;letter-spacing:.3px}
  .minmax{justify-content:center;align-items:flex-end;font-weight:900}
  .muted{color:var(--muted)}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:13px}
  /* FORECAST ROWS */
  .rows{display:flex;flex-direction:column;gap:10px}
  .row{display:grid;grid-template-columns: 1fr 1fr 1fr;align-items:center;padding:12px 14px;border-radius:14px;background:#0b0e13;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 4px 16px rgba(0,0,0,.25)}
  .rowIcon{font-size:24px}
  .rowMid{justify-self:center;font-weight:800}
  .rowRight{justify-self:end;font-weight:900}
  /* small helpers for grid placement */
  .tl{grid-column:1;grid-row:1}
  .ml{grid-column:1;grid-row:2}
  .bl{grid-column:1;grid-row:3}
  .tc{grid-column:2;grid-row:1}
  .mc{grid-column:2;grid-row:2}
  .bc{grid-column:2;grid-row:3}
  .tr{grid-column:3;grid-row:1;justify-content:flex-end}
  .br{grid-column:3;grid-row:3;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <!-- TOP MAIN PANEL -->
  <div class="top">
    <div class="cell tl"><span>üåÖ</span><span class="time" id="sunrise">--:--</span></div>
    <div class="cell tc icon" id="icon">‚òÄÔ∏è</div>
    <div class="cell tr bigtemp" id="temp">--¬∞</div>
    <div class="cell ml"><span>üåá</span><span class="time" id="sunset">--:--</span></div>
    <div class="cell mc minmax" id="minmax">--¬∞ | --¬∞</div>
    <div class="cell br city" id="city">‚Äî</div>
    <div class="cell bl"><span class="chip" id="wind">Vento ‚Äî</span></div>
  </div>

  <!-- FORECAST 3 ROWS -->
  <div class="rows" id="rows">
    <!-- Injected by JS -->
  </div>
</div>

<script>
const qs=new URLSearchParams(location.search);
// scale
const scale=Math.max(0.9,Math.min(1.6,parseFloat(qs.get('scale'))||1.10));
document.documentElement.style.fontSize=(16*scale)+'px';
// coordinates (default Trentola-Ducenta)
const lat=parseFloat(qs.get('lat')||'40.97');
const lon=parseFloat(qs.get('lon')||'14.18');
// optional city override
const cityOverride=qs.get('place');

function iconFor(code){
  if([0].includes(code)) return '‚òÄÔ∏è';
  if([1,2,3].includes(code)) return 'üå§Ô∏è';
  if([45,48].includes(code)) return 'üå´Ô∏è';
  if([51,53,55,56,57].includes(code)) return 'üå¶Ô∏è';
  if([61,63,65,80,81,82].includes(code)) return 'üåßÔ∏è';
  if([71,73,75,77,85,86].includes(code)) return 'üå®Ô∏è';
  if([95,96,99].includes(code)) return '‚õàÔ∏è';
  return '‚õÖ';
}
function dayLabel(iso){
  const d=new Date(iso+'T12:00:00'); // stabilize TZ
  const w=d.toLocaleDateString('it-IT',{weekday:'long'});
  const n=d.getDate();
  return w.charAt(0).toUpperCase()+w.slice(1)+', '+n;
}

async function load(){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`;
    const r=await fetch(url);
    const data=await r.json();
    // city
    let city=cityOverride;
    if(!city){
      try{
        const g=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=it`);
        const gj=await g.json();
        city=(gj && gj.results && gj.results[0])?(gj.results[0].name + (gj.results[0].admin1? ', '+gj.results[0].admin1:'')):'Localit√†';
      }catch(e){ city='Localit√†'; }
    }

    // top panel
    document.getElementById('temp').textContent = Math.round(data.current.temperature_2m)+'¬∞';
    document.getElementById('icon').textContent = iconFor(data.current.weather_code);
    document.getElementById('city').textContent = city;
    const sr=new Date(data.daily.sunrise[0]).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
    const ss=new Date(data.daily.sunset[0]).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
    document.getElementById('sunrise').textContent=sr;
    document.getElementById('sunset').textContent=ss;
    const tmax=Math.round(data.daily.temperature_2m_max[0]);
    const tmin=Math.round(data.daily.temperature_2m_min[0]);
    document.getElementById('minmax').textContent = `${tmax}¬∞ | ${tmin}¬∞`;
    document.getElementById('wind').textContent = `Vento: ${Math.round(data.current.wind_speed_10m)} m/s`;

    // forecast rows for next 3 days
    const cont=document.getElementById('rows'); cont.innerHTML='';
    for(let i=1;i<=3;i++){
      const row=document.createElement('div');
      row.className='row';
      const name=dayLabel(data.daily.time[i]);
      const code=data.daily.weather_code[i];
      const mx=Math.round(data.daily.temperature_2m_max[i]);
      const mn=Math.round(data.daily.temperature_2m_min[i]);
      row.innerHTML = `
        <div class="rowIcon">${iconFor(code)}</div>
        <div class="rowMid">${mx}¬∞ / ${mn}¬∞</div>
        <div class="rowRight">${name}</div>
      `;
      cont.appendChild(row);
    }
  }catch(e){
    console.error(e);
    document.getElementById('city').textContent='Errore meteo';
  }
}
load();
// refresh every 30 minutes
setInterval(load, 30*60*1000);
</script>
</body>
</html>
